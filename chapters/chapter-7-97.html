<p>Each of these operations may fail, and we donâ€™t have a distributed transaction broker in place. We ensure idem-potency and correctness as follows. First of all we only acknowledge the incoming device update records in Kafka after the last operation has completed. The database schema enforces some uniqueness constraints on the events being stored, so the insertion operation can fail if an event is being processed again. We simply handle a duplicate insertion error as a normal case to have idem-potency, and follow along with the next steps until they have all completed. A successful daily steps update Kafka record write allows us to acknowledge the initial device update record, and the system can make progress with the other incoming records.</p>