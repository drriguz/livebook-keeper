<p>We also enforce 2 integrity constraints with MongoDB indexes: both <code class="code">username</code> and <code class="code">deviceId</code> must be unique to a document. This avoids duplicate user names as well as 2 users having the same device. This will interestingly pose to be a correctness challenge when registering new users because we will not be able to use any transaction mechanism, so we will need to rollback partial data inserts when the <code class="code">deviceId</code> uniqueness constraint will prevent a duplicate insert.</p>